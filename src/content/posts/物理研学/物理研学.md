---
title: ç‰©ç†ç ”å­¦
published: 2024-09-21
description: 'ä»¥ä¸€ç§ç®€å•çš„æ–¹å¼å¯¹æœªæä¾› api çš„ç½‘ç«™ä¿¡æ¯è¿›è¡ŒæŠ“å–ï¼Œç”Ÿæˆå›¾è¡¨å¹¶æš´éœ²äºå…¬ç½‘ä¸­'
image: ''
tags: ['OpenFrp', 'å†…ç½‘ç©¿é€', 'ç½‘ç»œ']
category: 'ç½‘ç»œ'
draft: false 

---

![1726914216842](1726914216842.png)

ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…

ç‰©ç†ç ”å­¦ï¼Œæˆ‘åšè½¯ä»¶ã€‚è¦æ±‚å®ç°å¯¹ç¡¬ä»¶è®¾å¤‡ä¸Šä¼ çš„æ•°æ®è¿›è¡Œæ”¶é›†ï¼Œå¹¶ç”Ÿæˆå›¾è¡¨ã€‚

ç¡¬ä»¶è®¾å¤‡é‡‡é›†çš„æ•°æ®æˆ‘æ— æ³•ç›´æ¥è¿›è¡Œæ”¶é›†ï¼Œå®ƒæ‰€é‡‡é›†çš„ä¿¡æ¯ä¼šä¸Šä¼ è‡³ä¸€ç‰©è”ç½‘å¹³å°ã€‚ç‰©è”ç½‘å¹³å°ä¼šå°†æ•°æ®åˆ—ä¸ºä¸€ä¸ªè¡¨æ ¼ï¼Œå‘ˆç°ç»™ç”¨æˆ·ã€‚å…·ä½“åœ°ï¼š

![1726912484820](1726912484820.png)

æˆ‘æŸ¥é˜…ç½‘ç«™ api ç›¸å…³æ–‡æ¡£ï¼Œç®€ç›´å±ç”¨æ²¡æœ‰ã€‚

å°è¯•ä½¿ç”¨ F12 å¯¹æ•°æ®åŒ…è¿›è¡Œé‡‡é›†ï¼Œæ³¨æ„åˆ°æ¯æ¬¡ç¿»é¡µä¼šå‘å‡ºä¸€ä¸ªè¯·æ±‚ï¼Œå¦‚ä¸‹å›¾ï¼Œæˆ‘è¿›è¡Œäº†å››æ¬¡ç¿»é¡µæ“ä½œï¼Œä¸æ­¤åŒæ—¶å‘å‡ºäº†å››æ¬¡ forward è¯·æ±‚ï¼š

![1726912514810](1726912514810.png)

æ ¹æ®è¯·æ±‚ä¸­çš„æ ‡å¤´ï¼š

![1726912612501](1726912612501.png)

ä»¥åŠè¯·æ±‚è½½è·ï¼š

![1726912645132](1726912645132.png)

å¤§è‡´æ¨æµ‹å‡ºæ­¤ api çš„ä½¿ç”¨æ–¹æ³•ï¼š

- Authorization è¯´æ˜æŸ¥è¯¢çš„è®¾å¤‡ä¿¡æ¯ï¼Œç›´æ¥å¤åˆ¶å³å¯ã€‚
- Cookie è¯´æ˜ç”¨æˆ·ä¿¡æ¯ï¼Œç›´æ¥å¤åˆ¶å³å¯ã€‚

è½½è·ä¸­ï¼š

` {"method":"get","path":"api/v1/product/device/property/list","params":{"id":1872,"subId":"","propertyKey":"liuliang","interval":"","dateRange":[],"orderBy":"","pageNum":4,"pageSize":10}} `

æœ›æ–‡ç”Ÿä¹‰ã€‚

è§‚å¯Ÿå“åº”æ•°æ®ï¼š

```json
{
    "msg": "æ“ä½œæˆåŠŸ",
    "code": 200,
    "data": {
        "List": [
            {
                "ts": "2024-09-12 20:23:02",
                "timestamp": "2024-09-12T20:23:02+08:00",
                "value": 0,
                "subId": ""
            },
            {
                "ts": "2024-09-12 20:23:00",
                "timestamp": "2024-09-12T20:23:00+08:00",
                "value": 0,
                "subId": ""
            },
            {
                "ts": "2024-09-12 20:22:58",
                "timestamp": "2024-09-12T20:22:58+08:00",
                "value": 0,
                "subId": ""
            },
            {
                "ts": "2024-09-12 20:22:56",
                "timestamp": "2024-09-12T20:22:56+08:00",
                "value": 0,
                "subId": ""
            },
            {
                "ts": "2024-09-12 20:22:54",
                "timestamp": "2024-09-12T20:22:54+08:00",
                "value": 0,
                "subId": ""
            },
            {
                "ts": "2024-09-12 20:22:52",
                "timestamp": "2024-09-12T20:22:52+08:00",
                "value": 0,
                "subId": ""
            },
            {
                "ts": "2024-09-12 20:22:50",
                "timestamp": "2024-09-12T20:22:50+08:00",
                "value": 0,
                "subId": ""
            },
            {
                "ts": "2024-09-12 20:22:48",
                "timestamp": "2024-09-12T20:22:48+08:00",
                "value": 0,
                "subId": ""
            },
            {
                "ts": "2024-09-12 20:22:46",
                "timestamp": "2024-09-12T20:22:46+08:00",
                "value": 0,
                "subId": ""
            },
            {
                "ts": "2024-09-12 20:22:42",
                "timestamp": "2024-09-12T20:22:42+08:00",
                "value": 0,
                "subId": ""
            }
        ],
        "currentPage": 4,
        "Total": 51819
    }
}
```

ç»è¿‡å°è¯•ï¼ŒpageSize æœ€å¤§ä¸º 1000ï¼Œè¡¨ç¤ºä¸ºè¿”å›æ•°æ®å¤§å°ã€‚

æ®æ­¤åˆ©ç”¨æ­¤ api å†™å‡ºä»£ç æŠ“å–æ•°æ®ï¼Œè¿™é‡Œæˆ‘é‡‡ç”¨è¾ƒæ–¹ä¾¿çš„ node.js è¿›è¡Œç¼–å†™ï¼š

```js
const express = require('express');
const cors = require('cors');
const axios = require('axios');

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors());

const config = {
    method: 'post',
    url: 'http://iotn.developlink.cloud/prod-api/iot/data/forward',
    headers: {
        'Accept': 'application/json',
        "Authorization": "Bearer [é©¬èµ›å…‹]",
        'Cookie': 'username=[é©¬èµ›å…‹]; password=[é©¬èµ›å…‹]; rememberMe=true; formType=2; usePwd=[object%20Object]; sidebarStatus=0',
        "Content-Type": "application/json;charset=UTF-8",
        "Accept-Encoding": "gzip, deflate",
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36'
    }
};

app.get('/api/data', async (req, res) => {
    try {
        const { pageNum = 1, pageSize = 1000 } = req.query; 

        const updatedConfig = {
            ...config,
            data: {
                "method": "get",
                "path": "api/v1/product/device/property/list",
                "params": {
                    "id": 1872,
                    "subId": "",
                    "propertyKey": "liuliang",
                    "interval": "",
                    "dateRange": [],
                    "orderBy": "",
                    "pageNum": parseInt(pageNum), // å½“å‰é¡µæ•°
                    "pageSize": parseInt(pageSize) // æ¯é¡µçš„æ•°æ®é‡
                }
            }
        };

        const response = await axios(updatedConfig);
        res.json(response.data);
    } catch (error) {
        console.error(error);
        res.status(500).send('Error fetching data');
    }
});

app.listen(PORT, () => {
    console.log(`Server is running on port ${PORT}`);
});
```

æ³¨æ„æ­¤ä»£ç ä¾èµ– expressã€corsã€axios è¿™ä¸‰ä¸ªåº“ï¼Œè‡ªè¡Œå®‰è£…

æ®æ­¤å¯å†™å‡ºç”Ÿæˆå›¾è¡¨çš„ HTML ä»£ç ï¼š

```html
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ°´é‡ç›‘æµ‹</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #loading {
            display: none;
            font-size: 20px;
            text-align: center;
            margin-top: 20px;
        }

        form {
            margin-bottom: 20px;
            text-align: center;
        }

        h1 {
            text-align: center;
        }


        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 24px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

            button:hover {
                background-color: #45a049;
            }

        input[type="datetime-local"] {
            margin: 10px 0;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }

            input[type="datetime-local"]:focus {
                border-color: #4CAF50;
            }
    </style>
</head>
<body>
    <h1>æ°´é‡ç›‘æµ‹</h1>
    <form id="dateForm">
        <label for="startDateTime">å¼€å§‹æ—¥æœŸå’Œæ—¶é—´:</label>
        <input type="datetime-local" id="startDateTime" name="startDateTime">
        <label for="endDateTime">ç»“æŸæ—¥æœŸå’Œæ—¶é—´:</label>
        <input type="datetime-local" id="endDateTime" name="endDateTime">
        <button type="submit">ç­›é€‰</button>
    </form>

    <div id="loading">åŠ è½½ä¸­...</div>
    <canvas id="line-chart" width="800" height="400"></canvas>

    <script>
        let chartInstance = null; // ä¿å­˜å›¾è¡¨å®ä¾‹
        let allDataFetched = false; // æ˜¯å¦å·²è·å–æ‰€æœ‰æ•°æ®
        let allData = []; // ç”¨äºå­˜å‚¨æ‰€æœ‰æ•°æ®

        // é€’å½’è·å–æ‰€æœ‰åˆ†é¡µæ•°æ®çš„å‡½æ•°
        async function fetchAllData(pageNum = 1, pageSize = 1000) {
            const response = await fetch(`http://water-api.mitufun.top/api/data?pageNum=${pageNum}&pageSize=${pageSize}`);
            const data = await response.json();

            if (data && data.msg === "æ“ä½œæˆåŠŸ" && data.code === 200) {
                allData = allData.concat(data.data.List);

                if (data.data.List.length === pageSize) {
                    return fetchAllData(pageNum + 1, pageSize);
                }
            }
            allDataFetched = true; // æ ‡è®°æ‰€æœ‰æ•°æ®å·²è·å–
        }

        // å¤„ç†å’Œå»é‡æ•°æ®
        function filterData(startDateTime, endDateTime) {
            const startTime = new Date(startDateTime).getTime();
            const endTime = new Date(endDateTime).getTime();

            const filteredData = allData.filter(item => {
                const itemTime = new Date(item.ts.replace(/-/g, '/')).getTime();
                return itemTime >= startTime && itemTime <= endTime;
            });

            return filteredData;
        }

        // å¤„ç†æ•°æ®å¹¶ç”Ÿæˆæ€»å’Œ
        function processData(data) {
            const segmentCount = 20; // è¦æ˜¾ç¤ºçš„æ•°æ®æ®µæ•°
            const segmentSize = Math.ceil(data.length / segmentCount);
            const reducedData = [];
            const reducedTimestamps = [];

            for (let i = 0; i < segmentCount; i++) {
                const segment = data.slice(i * segmentSize, (i + 1) * segmentSize);
                if (segment.length === 0) break; // å¦‚æœæ²¡æœ‰æ›´å¤šæ®µäº†ï¼Œé€€å‡º

                const totalValue = segment.reduce((sum, item) => sum + item.value, 0);
                const lastTimestamp = segment[segment.length - 1].ts; // è·å–è¯¥æ®µçš„æœ€åä¸€ä¸ªæ—¶é—´æˆ³

                reducedData.push(totalValue);
                reducedTimestamps.push(lastTimestamp);
            }

            // ç¿»è½¬æ•°æ®ä»¥ç¡®ä¿æ—¶é—´ä»å·¦åˆ°å³
            return {
                reducedData: reducedData.reverse(),
                reducedTimestamps: reducedTimestamps.reverse()
            };
        }

        async function fetchData(startDateTime = null, endDateTime = null) {
            if (!allDataFetched) {
                document.getElementById('loading').style.display = 'block'; // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                await fetchAllData();
                document.getElementById('loading').style.display = 'none'; // éšè—åŠ è½½åŠ¨ç”»
            }

            let dataToDisplay = [];

            if (startDateTime && endDateTime) {
                dataToDisplay = filterData(startDateTime, endDateTime);
            } else {
                dataToDisplay = allData; // å¦‚æœæ²¡æœ‰æ—¶é—´ç­›é€‰ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®
            }

            // å¤„ç†æ•°æ®å¹¶ç»˜åˆ¶å›¾è¡¨
            if (dataToDisplay.length > 0) {
                const { reducedData, reducedTimestamps } = processData(dataToDisplay);

                // ç»˜åˆ¶å›¾è¡¨
                if (chartInstance) {
                    chartInstance.destroy(); // é”€æ¯æ—§å›¾è¡¨
                }

                const ctx = document.getElementById('line-chart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: reducedTimestamps, // Xè½´ï¼šæ—¶é—´æˆ³
                        datasets: [{
                            label: 'æµé‡æ•°æ®æ€»å’Œ',
                            data: reducedData, // Yè½´ï¼šæ•°æ®å€¼
                            borderColor: 'rgba(75, 192, 192, 1)',
                            fill: false,
                            tension: 0.1 // çº¿çš„å…‰æ»‘ç¨‹åº¦
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: 'æ—¶é—´'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: 'æµé‡æ€»å’Œ'
                                }
                            }
                        }
                    }
                });
            } else {
                alert('æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®');
            }
        }

        document.getElementById('dateForm').addEventListener('submit', function (event) {
            event.preventDefault();
            const startDateTimeInput = document.getElementById('startDateTime').value;
            const endDateTimeInput = document.getElementById('endDateTime').value;

            if (!startDateTimeInput || !endDateTimeInput) {
                alert('è¯·å¡«å†™å¼€å§‹å’Œç»“æŸæ—¥æœŸæ—¶é—´');
                return;
            }

            fetchData(startDateTimeInput.replace('T', ' '), endDateTimeInput.replace('T', ' '));
        });

        // åˆå§‹è·å–æ‰€æœ‰æ•°æ®
        fetchData();
    </script>

    <h5>Developed by <a href="https://www.mitufun.top">MituFun</a></h5>
</body>
</html>
```

åŒæ ·ä½¿ç”¨ node.js å°†æ­¤ HTML è¿è¡Œåœ¨æœ¬åœ°æœåŠ¡å™¨ä¸Šï¼š

```js
const express = require('express');
const path = require('path');

const app = express();
const PORT = 3001;

app.use(express.static(path.join(__dirname)));

app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'index.html'));
});

app.listen(PORT, () => {
    console.log(`æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼šhttp://localhost:${PORT}`);
});
```

å…ˆè¿è¡ŒæŠ“å–æ•°æ®çš„ç¨‹åºï¼Œæ­¤æ—¶è®¿é—® `localhost:3001` å³å¯æŸ¥è¯¢å›¾è¡¨ã€‚æ³¨æ„åˆ°ä¸Šé¢çš„å›¾è¡¨ HTML æ–‡ä»¶æŠ“å–æ•°æ®æ˜¯åœ¨ `water-api.mitufun.top` æ˜¯å› ä¸ºæˆ‘ä½¿ç”¨å†…ç½‘ç©¿é€å°†æœ¬åœ° `localhost:3000` æ”¾åˆ°äº† `water-api.mitufun.top`ã€‚å¦‚æœæœ¬åœ°æµ‹è¯•ï¼Œè¯·ä¿®æ”¹ä¸º `localhost:3000`ã€‚

å…³äºé“¾æ¥åŸŸåï¼Œå†…ç½‘ç©¿é€ç±»å‹é…ç½® HTTPï¼Œç„¶åè®©ä½ çš„åŸŸå DNS ä»¥ CNAME ç±»å‹å­˜ä¸€ä¸‹å†…ç½‘ç©¿é€ç½‘å€å³å¯ã€‚

[å›¾è¡¨æµ‹è¯•ç½‘å€](http://water.mitufun.top) [api æµ‹è¯•ç½‘å€](http://water-api.mitufun.top)

[æ‰€æœ‰ä»£ç å·²æ‰˜ç®¡è‡³ GitHub](https://github.com/MituFun/water)



